{% load wagtailadmin_tags %}

<div class="nice-padding">
    <h2>Create New Tag</h2>

    <form action="{% url 'portfolio:tag_modal' %}" method="POST" id="tag-form">
        {% csrf_token %}
        
        {% for field in form %}
            <div class="field">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
                {% if field.errors %}
                    <p class="error-message">{{ field.errors.0 }}</p>
                {% endif %}
            </div>
        {% endfor %}
        
        <div class="actions">
            <button type="submit" class="button button-primary">Create Tag</button>
            <button type="button" class="button" onclick="window.parent.ModalWorkflow.closeModal();">Cancel</button>
        </div>
    </form>
</div>

<script>
    document.getElementById('tag-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        var formData = new FormData(this);
        
        // Create XMLHttpRequest
        var xhr = new XMLHttpRequest();
        xhr.open('POST', this.action, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        
        xhr.onload = function() {
            if (xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                if (response.step === 'success') {
                    // Close modal and return to parent window
                    try {
                        window.parent.postMessage({
                            tag_id: response.tag_id,
                            tag_name: response.tag_name,
                            success: true
                        }, '*');
                        
                        // Try to close the modal using different approaches
                        if (window.parent.ModalWorkflow && typeof window.parent.ModalWorkflow.closeModal === 'function') {
                            window.parent.ModalWorkflow.closeModal(response);
                        } else if (window.parent.closeModal) {
                            window.parent.closeModal(response);
                        } else {
                            // As a fallback, reload the parent page
                            window.parent.location.reload();
                        }
                    } catch (e) {
                        // If all else fails, just reload the parent
                        window.parent.location.reload();
                    }
                } else {
                    // Replace the current form with the updated one
                    document.getElementsByClassName('nice-padding')[0].innerHTML = response.html;
                }
            }
        };
        
        // Convert FormData to URL-encoded string
        var params = new URLSearchParams();
        for (var pair of formData.entries()) {
            params.append(pair[0], pair[1]);
        }
        
        xhr.send(params);
    });
</script>